import 'package:flutter/material.dart';
import '../constants/ui_constants.dart';
import '../constants/ui_styles.dart';

class AgbScreen extends StatelessWidget {
  const AgbScreen({super.key});

  static const String agbText = '''
Allgemeine Geschäftsbedingungen Lehrgang (AGB-L)

1. Geltungsbereich
1.1 Diese Allgemeinen Geschäftsbedingungen Lehrgang (nachfolgend "AGB-L") des Bayerischen Sportschützenbundes e.V. (nachfolgend "BSSB" oder "Veranstalter") gelten für alle Leistungen des BSSB im Rahmen von Seminaren, Schulungen, Kursen, Trainingseinheiten und Aus- und Weiterbildungen des BSSB (im Folgenden "Veranstaltungen") für Mitglieder und Nichtmitglieder (nachfolgend "Teilnehmer"). Hiermit wird der Einbeziehung von eigenen Bedingungen des Teilnehmers widersprochen, es sei denn, ihrer Geltung wurde ausdrücklich zugestimmt.

2. Art und Umfang der Leistung
Der BSSB bietet Veranstaltungen in seinen Räumen auf der Olympia Schießanlage (Ingolstädter Landstraße 110, 85748 Garching-Hochbrück), den BSSB Standorten sowie mit den Teilnehmern vereinbarten Räumen an.

2.1 Die Teilnehmer erhalten während des Unterrichts Heiß- oder Kaltgetränke. Diese Bewirtungskosten sind in den Veranstaltungsgebühren enthalten. Bezüglich der Verpflegung ist die Ausschreibung der jeweiligen Veranstaltung zu beachten.

2.2 Die Teilnehmer erhalten darüber hinaus Seminarunterlagen, die den Inhalt der Veranstaltung begleiten und das Nachlesen ermöglichen, soweit es die Veranstaltung erforderlich macht. Die Entscheidung obliegt den Referenten.

2.3 Jeder Teilnehmer erhält für seine Seminarteilnahme eine auf ihn persönlich ausgestellte Teilnahmebescheinigung.

2.4 Für die Planung der Reisen zum Veranstaltungsort und Buchung von Hotelzimmern ist der Teilnehmer selbst verantwortlich, soweit nichts anderes vereinbart ist. Bei unverschuldetem Ausfall oder Absage der Veranstaltung können keine Ersatzansprüche geltend gemacht werden.

3. Vertragsschluss
3.1 Alle Angebote des BSSB sind unverbindlich, solange sie nicht zum Inhalt einer vertraglichen Vereinbarung werden. Sie dienen der Abgabe eines Angebotes durch den Teilnehmer. Der Teilnehmer kann sein Angebot über das auf der Internetseite des BSSB vorgehaltenen Onlineanmeldung abgeben, sofern es nicht anderweitig in der Ausschreibung der Veranstaltung geregelt wird. Dabei gibt er nach Eingabe seiner persönlichen Daten und durch Klicken des Buttons "Anmelden" im abschließenden Schritt des Bestellprozesses ein rechtlich verbindliches Vertragsangebot in Bezug auf die von ihm ausgewählte Veranstaltung ab.

Der Vertrag mit dem BSSB kommt erst zustande, wenn der BSSB das Angebot des Teilnehmers durch Bestätigung per E-Mail annimmt.

4. Widerrufsbelehrung
Teilnehmern steht ein Widerrufsrecht nach folgender Maßgabe zu, wobei ein Teilnehmer jede natürliche Person ist, die ein Rechtsgeschäft zu einem Zwecke abschließt, der weder ihrer gewerblichen noch ihrer selbständigen beruflichen Tätigkeit zugerechnet werden kann:

Widerrufsrecht
Sie können Ihre Vertragserklärung innerhalb von 8 Kalendertage ohne Angabe von Gründen über das Webportal "MeinBSSB" online widerrufen. Die Frist beginnt nach Erhalt dieser Belehrung in Textform, jedoch nicht vor Vertragsschluss und auch nicht vor Erfüllung unserer Informationspflichten gemäß Artikel 246 § 2 in Verbindung mit § 1 Absatz 1 und 2 EGBGB sowie unserer Pflichten gemäß § 312g Absatz 1 Satz 1 BGB in Verbindung mit Artikel 246 § 3 EGBGB. Zur Wahrung der Widerrufsfrist genügt die rechtzeitige Absendung des Widerrufs. Der Widerruf hat über die Internetseite des BSSB mit dem entsprechenden Abmelde-Button im "MeinBSSB" zu erfolgen.

Widerrufsfolgen
Im Falle eines wirksamen Widerrufs sind die beiderseits empfangenen Leistungen zurückzugewähren und ggf. gezogene Nutzungen (z.B. Zinsen) herauszugeben. Verpflichtungen zur Erstattung von Zahlungen müssen innerhalb von 30 Tagen erfüllt werden. Die Frist beginnt für Sie mit der Absendung Ihrer Widerrufserklärung, für uns mit deren Empfang.

Besondere Hinweise
Ihr Widerrufsrecht erlischt vorzeitig, wenn der Vertrag von beiden Seiten auf Ihren ausdrücklichen Wunsch vollständig erfüllt ist, bevor Sie Ihr Widerrufsrecht ausgeübt haben.

5. Stornierung durch den Teilnehmer, Absage durch den BSSB
5.1 Der BSSB bietet dem Teilnehmer die Möglichkeit der Stornierung zu den nachfolgenden Bedingungen.
5.1.1 Der Teilnehmer ist berechtigt, das Vertragsverhältnis bis 8 oder mehr Kalendertage vor Veranstaltungsbeginn (Eingang der Stornierung beim BSSB) kostenfrei zu stornieren.
5.1.2 Bei Stornierung innerhalb der 8 Kalendertage vor Veranstaltungsbeginn oder Nichterscheinen ist die Rechnungssumme in voller Höhe zu zahlen.
5.1.3 Stornierungen müssen über das Webportal "MeinBSSB" online erfolgen.
5.1.4 Das Widerrufsrecht des Teilnehmers gemäß Ziffer 4 bleibt unberührt.

5.2 Der BSSB ist berechtigt, Veranstaltungen bis 8 Kalendertage vor Veranstaltungsbeginn abzusagen oder räumlich zu verlegen und /oder einen anderen Termin ersatzweise zu benennen. Aus wichtigem Grund – u.a. bei Erkrankungen des oder der Referenten oder bei zu geringer Teilnehmerzahl – kann die Veranstaltung gegen volle Erstattung bereits gezahlter Gebühren kurzfristig abgesagt werden. Weitergehende Ansprüche bestehen nicht.

6. Rechte an den Schulungsunterlagen
6.1 Der BSSB räumt dem Teilnehmer das nicht ausschließliche, dauerhafte, unwiderrufliche und nicht übertragbare Recht ein, die im Rahmen von Veranstaltungen überlassenen Schulungsunterlagen zu nutzen. Diese Rechte schließen auch Hilfsmittel, wie elektronische Präsentationsdateien und zur Schulung verwendete Muster ein. Eine Vervielfältigung und Digitalisierung der Schulungsunterlagen ist untersagt. Eine Nutzung für kommerzielle Zwecke, die Verwendung außerhalb des ehrenamtlichen Sportbetriebs sowie Vervielfältigung und Speicherung auf elektronischen Medien und das Einstellen ins Internet sind nicht gestattet.
Davon abgesehen dürfen alle Teile der überlassenen Schulungsunterlagen zu Ausbildungszwecken innerhalb des Bayerischen Sportschützenbundes auf Vereins-, Gau- und Bezirksebene vollständig oder auszugsweise genutzt und vervielfältigt werden. Dabei ist jedoch auf die Urheber-, Quellen- und Literaturangabe sowie eine korrekte Zitierweise zu achten.
6.2 Abweichungen von diesen Nutzungsregelungen bedürfen der Vereinbarung im Einzelvertrag.

7. Vergütung und Zahlungsbedingungen
7.1 Die in Publikationen und auf der Internetpräsenz angegebenen Preise des BSSB sind als Bruttoeuropreise zu verstehen, inklusive der gesetzlichen deutschen Umsatzsteuer.
7.2 SEPA-Lastschriftverfahren
Der Rechnungsbetrag wird im SEPA-Lastschriftverfahren abgebucht. Der Betrag ist nach Abschluss der entsprechenden Maßnahme sofort fällig.
Indem der Teilnehmer dem BSSB seine Bankverbindung mitteilt, ermächtigt er den BSSB, Zahlungen von seinem Bankkonto mittels Lastschrift einzuziehen. Zugleich weisen er sein Kreditinstitut an, die vom BSSB auf sein Konto gezogenen Lastschriften einzulösen. Im Rahmen der mit seinem Kreditinstitut vereinbarten Bedingungen kann der Teilnehmer innerhalb von acht Wochen, beginnend mit dem Belastungsdatum, die Erstattung des belasteten Betrages verlangen.
Zur Erleichterung des Zahlungsverkehrs beträgt die Frist für die Information vor Einzug einer fälligen Zahlung mindestens einen Tag vor Belastung.
Wenn seine Bank die Lastschrift aus Gründen ablehnt, für die der Teilnehmer verantwortlich ist (z.B. unzureichende Kontodeckung), können wir zusätzlich zu dem Recht, den geschuldeten Betrag einzuziehen, eine zusätzliche Gebühr von 10€ erheben. Dies hat keinen Einfluss auf sein Recht, das Lastschriftmandat kostenlos zu widerrufen, soweit wir keinen Anspruch auf den entsprechenden Betrag gegen ihn haben oder, wenn er nachweisen kann, dass der Schaden überhaupt nicht eingetreten ist oder deutlich unter 10€ liegt.
Der Teilnehmer kann sein SEPA-Lastschriftmandat in seinen Kundenstammdaten auf dem Webportal "MeinBSSB" einsehen und ändern.

Durch das Hinterlegen einer neuen Bankverbindung übermitteln er uns ein neues SEPA-Lastschriftmandat, das automatisch mit den von ihm eingegebenen Daten in seinen Kundenstammdaten hinterlegt wird.
Der Teilnehmer kann sein SEPA-Lastschriftmandat jederzeit im Webportal "MeinBSSB" stornieren. Indem er seine Bankverbindung löscht, storniert er gleichzeitig sein SEPA-Lastschriftmandat. Das Löschen Ihrer Bankverbindung wirkt sich nicht auf offene Bestellungen aus, die eingeleitet wurden.

8. Anwendbares Recht, Gerichtsstand
8.1 Für sämtliche Rechtsbeziehungen der Parteien gilt das Recht der Bundesrepublik Deutschland unter Ausschluss der Gesetze über den internationalen Kauf beweglicher Waren und unter Ausschluss von Kollisionsrecht. Bei Verbrauchern gilt diese Rechtswahl nur insoweit, als nicht der gewährte Schutz durch zwingende Bestimmungen des Rechts des Staates, in dem der Verbraucher seinen gewöhnlichen Aufenthalt hat, entzogen wird.

8.2 Handelt der Teilnehmer als Kaufmann, juristische Person des öffentlichen Rechts oder öffentlichrechtliches Sondervermögen mit Sitz im Hoheitsgebiet der Bundesrepublik Deutschland, ist ausschließlicher Gerichtsstand für alle Streitigkeiten aus diesem Vertrag der Geschäftssitz des Verkäufers. Hat der Teilnehmer seinen Sitz außerhalb des Hoheitsgebiets der Bundesrepublik Deutschland, ist der Geschäftssitz des Veranstalters ausschließlicher Gerichtsstand für alle Streitigkeiten aus diesem Vertrag, wenn der Vertrag oder Ansprüche aus dem Vertrag der beruflichen oder gewerblichen Tätigkeit des Teilnehmers zugerechnet werden können. Der Verkäufer ist in den vorstehenden Fällen jedoch in jedem Fall berechtigt, das Gericht am Sitz des Teilnehmers anzurufen.

Stand: 01.12.2022
''';

  @override
  Widget build(BuildContext context) {
    final List<_AgbSection> sections = _parseAgbText(agbText);
    return Scaffold(
      backgroundColor: UIConstants.backgroundColor,
      appBar: AppBar(
        title: const Text('AGB', style: UIStyles.appBarTitleStyle),
        backgroundColor: UIConstants.backgroundColor,
        elevation: UIConstants.appBarElevation,
        iconTheme: const IconThemeData(color: UIConstants.textColor),
      ),
      body: Center(
        child: SingleChildScrollView(
          child: Container(
            margin: const EdgeInsets.symmetric(
              vertical: UIConstants.spacingL,
              horizontal: UIConstants.spacingM,
            ),
            padding: UIConstants.defaultPadding,
            decoration: BoxDecoration(
              color: UIConstants.cardColor,
              borderRadius: BorderRadius.circular(UIConstants.cornerRadius),
              boxShadow: UIStyles.cardDecoration.boxShadow,
            ),
            child: Builder(
              builder: (context) {
                // Remove the last line if it starts with 'Stand:' and treat as footer
                final List<_AgbSection> mainSections = List.from(sections);
                String? footer;
                if (mainSections.isNotEmpty &&
                    mainSections.last.paragraphs.isNotEmpty) {
                  final lastParas = mainSections.last.paragraphs;
                  final lastLine = lastParas.last.trim();
                  if (lastLine.startsWith('Stand:')) {
                    footer = lastLine;
                    lastParas.removeLast();
                    // If the last section is now empty, remove it
                    if (lastParas.isEmpty) {
                      mainSections.removeLast();
                    }
                  }
                }
                return Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    for (final section in mainSections) ...[
                      if (section.title != null) ...[
                        Text(
                          section.title!,
                          style: UIStyles.sectionTitleStyle,
                        ),
                        UIConstants.verticalSpacingS,
                      ],
                      for (final para in section.paragraphs) ...[
                        if (RegExp(r'^\d+(?:\.\d+)*\.\s*').hasMatch(para) &&
                            !para.startsWith('Stand:'))
                          _buildNumberedParagraph(para)
                        else
                          Text(
                            para,
                            style: UIStyles.bodyStyle,
                          ),
                        UIConstants.verticalSpacingXS,
                      ],
                      UIConstants.verticalSpacingM,
                    ],
                    if (footer != null)
                      Padding(
                        padding:
                            const EdgeInsets.only(top: UIConstants.spacingS),
                        child: Text(
                          footer,
                          style: UIStyles.bodyStyle.copyWith(
                            fontStyle: FontStyle.italic,
                          ),
                          textAlign: TextAlign.right,
                        ),
                      ),
                  ],
                );
              },
            ),
          ),
        ),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () => Navigator.of(context).pop(),
        backgroundColor: UIConstants.defaultAppColor,
        child: const Icon(
          Icons.close,
          color: Colors.white,
        ),
      ),
    );
  }
}

class _AgbSection {
  _AgbSection({this.title, required this.paragraphs});
  final String? title;
  final List<String> paragraphs;
}

List<_AgbSection> _parseAgbText(String text) {
  final lines = text.split('\n');
  final List<_AgbSection> sections = [];
  String? currentTitle;
  List<String> currentParagraphs = [];
  final sectionHeaderRegex = RegExp(r'^(\d+\.|[A-Z][a-z]+:?)');

  for (final line in lines) {
    final trimmed = line.trim();
    if (trimmed.isEmpty) continue;
    // Skip "Stand:" lines as they should be treated as footer, not section headers
    if (trimmed.startsWith('Stand:')) {
      currentParagraphs.add(trimmed);
    } else if (sectionHeaderRegex.hasMatch(trimmed) &&
        trimmed.length < UIConstants.maxSectionHeaderLength &&
        // Exclude numbered subparagraphs (like 5.1, 5.1.1, 5.1.4.) from being section headers
        !RegExp(r'^\d+\.\d').hasMatch(trimmed) &&
        // Also exclude lines that end with a dot followed by text (like "5.1.4. Das Widerrufsrecht...")
        !RegExp(r'^\d+\.\d+\.\s').hasMatch(trimmed)) {
      if (currentParagraphs.isNotEmpty || currentTitle != null) {
        sections.add(
          _AgbSection(title: currentTitle, paragraphs: currentParagraphs),
        );
        currentParagraphs = [];
      }
      currentTitle = trimmed;
    } else {
      currentParagraphs.add(trimmed);
    }
  }
  if (currentParagraphs.isNotEmpty || currentTitle != null) {
    sections
        .add(_AgbSection(title: currentTitle, paragraphs: currentParagraphs));
  }
  return sections;
}

Widget _buildNumberedParagraph(String para) {
  // Match patterns like "5.1", "5.1.1", "5.1.2", "5.1.4.", etc.
  // Handle both cases: with and without extra dot at the end
  // More flexible regex that handles optional extra dot
  final regex = RegExp(r'^(\d+(?:\.\d+)*)\.?\s*(.*)');
  final match = regex.firstMatch(para);

  if (match != null) {
    final numbers = match.group(1)!; // e.g., "5.1" or "5.1.1"
    final text = match.group(2)!; // The rest of the text

    // Check if the original paragraph has a dot after the numbers
    final hasExtraDot = para.trim().startsWith('$numbers. ');

    return Text.rich(
      TextSpan(
        children: [
          TextSpan(
            text: hasExtraDot ? '$numbers.' : numbers,
            style: UIStyles.bodyStyle.copyWith(
              fontWeight: FontWeight.bold,
              fontSize: UIStyles.bodyStyle.fontSize! * 1.2, // Make it larger
              color: UIConstants.textColor, // Use text color (black)
            ),
          ),
          TextSpan(
            text: hasExtraDot ? ' $text' : ' $text',
            style: UIStyles.bodyStyle,
          ),
        ],
      ),
    );
  }

  // Fallback for any other numbered paragraphs
  return Text(
    para,
    style: UIStyles.bodyStyle,
  );
}
