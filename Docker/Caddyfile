# Serve Flutter Web App using http 
http://:8080 {
  root * /web
  file_server
  try_files {path} /index.html
}

# Serve PostgREST API with full CORS support
http://:8081 {

  # Handle CORS preflight requests (OPTIONS)
  @cors_preflight {
    method OPTIONS
  }

  handle @cors_preflight {
    respond "" 204
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, PATCH, DELETE"
    header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Prefer"
    header Access-Control-Allow-Credentials "false"
  }

  # Handle all actual API calls with CORS headers
  handle {
    reverse_proxy postgrest:3000
    header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, PATCH, DELETE"
    header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Prefer"
    header Access-Control-Allow-Credentials "false"
  }
}

# Serve ZMI Monitoring Dashboard
http://:8083 {
  reverse_proxy zmi-monitor:80
}
