{
  local_certs
}
# Redirect HTTP to HTTPS
http://meintest.bssb.de {
  redir https://meintest.bssb.de{uri}
}

# Serve Flutter Web App (HTTPS)
https://meintest.bssb.de {
  root * /web
  file_server
  try_files {path} /index.html
}

# Serve PostgREST API (HTTPS) on port 8081 - requires API key header
https://meintest.bssb.de:8081 {
  @cors_preflight {
    method OPTIONS
  }

  @has_api_key {
    header X-API-Key *
  }

  handle @cors_preflight {
    respond "" 204
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, PATCH, DELETE"
    header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Prefer, X-API-Key"
    header Access-Control-Allow-Credentials "false"
  }

  # Block requests without API key (browser direct access)
  @blocked {
    not method OPTIONS
    not header X-API-Key *
  }

  handle @blocked {
    respond "Access denied. API key required." 403
  }

  handle {
    reverse_proxy postgrest:3000
    header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, PATCH, DELETE"
    header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Prefer, X-API-Key"
    header Access-Control-Allow-Credentials "false"
  }
}
https://meintest.bssb.de:8080 {
    reverse_proxy email-service:3001
    header {
      Access-Control-Allow-Origin "*"
      Access-Control-Allow-Methods "POST, OPTIONS"
      Access-Control-Allow-Headers "Authorization, Content-Type"
    }
}

https://meintest.bssb.de:8082 {
    reverse_proxy token-service:3002
    header {
      Access-Control-Allow-Origin "*"
      Access-Control-Allow-Methods "POST, OPTIONS"
      Access-Control-Allow-Headers "Authorization, Content-Type"
    }
}

https://meintest.bssb.de:8083 {
  reverse_proxy zmi-monitor:80
}
